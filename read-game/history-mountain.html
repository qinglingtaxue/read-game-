<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²ä¹‹å±±æ¢ç´¢ä¹‹æ—…</title>
    <link rel="stylesheet" href="css/history-mountain.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">â† è¿”å›å…¨æ™¯</button>

    <!-- è¿›åº¦æ˜¾ç¤º -->
    <div class="progress-display">
        <span class="mountain-progress">å†å²å±±è¿›åº¦ï¼š<span id="mountain-progress">0/7</span></span>
        <span class="total-progress">æ€»è¿›åº¦ï¼š<span id="total-progress">0/420</span></span>
    </div>
    
    <div class="mountain-scene">
        <!-- äº‘æœµ -->
        <div class="cloud cloud1"></div>
        <div class="cloud cloud2"></div>
        
        <!-- å±±è„‰å±‚æ¬¡ -->
        <div class="distant-mountains"></div>
        <div class="middle-mountains"></div>
        <div class="front-mountains"></div>

        <!-- å†å²æ²³æµ - ç»§æ‰¿å¤ªé˜³å±±æ ·å¼ -->
        <div class="history-rivers">
            <div class="history-river river-chinese-general" data-range="chinese-general" onclick="exploreRange('chinese-general')" title="ä¸­å›½é€šå²"></div>
            <div class="history-river river-world-general" data-range="world-general" onclick="exploreRange('world-general')" title="ä¸–ç•Œé€šå²"></div>
            <div class="history-river river-chinese-dynastic-special" data-range="chinese-dynastic-special" onclick="exploreRange('chinese-dynastic-special')" title="ä¸­å›½æ–­ä»£å²"></div>
            <div class="history-river river-western-dynastic-special" data-range="western-dynastic-special" onclick="exploreRange('western-dynastic-special')" title="è¥¿æ–¹æ–­ä»£å²"></div>
        </div>
        
        <!-- å¯¼æ¸¸äººç‰©å’Œå¯¹è¯æ°”æ³¡ -->
        <div class="guide-section">
            <div class="guide-character">
                <div class="guide-avatar">ğŸ“œ</div>
                <div class="guide-name">å†å²å‘å¯¼</div>
            </div>
            <div class="speech-bubble">
                <div class="bubble-content">
                    <h3>ğŸ›ï¸ æ¬¢è¿æ¥åˆ°å†å²ä¹‹å±±</h3>
                    <p>åœ¨è¿™åº§åº„é‡çš„å±±å³°ä¸Šï¼Œå››æ¡å†å²ä¹‹æ²³é™é™æµæ·Œã€‚ä¸­å›½é€šå²æ²³è„‰ç»œä¸­åæ–‡æ˜ï¼Œä¸–ç•Œé€šå²æ²³è¿ç»“å…¨çƒè¿›ç¨‹ï¼Œä¸­å›½æ–­ä»£å²ä¸ä¸“é¢˜æ²³æ·±ç©¶åå¤ç»†èŠ‚ï¼Œè¥¿æ–¹æ–­ä»£å²ä¸ä¸“é¢˜æ²³å‰–æè¥¿æ–¹å˜è¿ã€‚ä¸ƒä½å†å²å·¨åŒ åœ¨æ­¤ç­‰å€™ã€‚</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ™ºè€…åŒºåŸŸ -->
        <div class="right-side-sages">
            <div class="sage-figure sage-simaqian" data-sage="simaqian" onclick="exploreSage('simaqian')">
                <div class="sage-avatar">âœï¸</div>
                <div class="sage-name">å¸é©¬è¿</div>
            </div>
            
            <div class="sage-figure sage-thucydides" data-sage="thucydides" onclick="exploreSage('thucydides')">
                <div class="sage-avatar">ğŸ›ï¸</div>
                <div class="sage-name">ä¿®æ˜”åº•å¾·</div>
            </div>
            
            <div class="sage-figure sage-simaguang" data-sage="simaguang" onclick="exploreSage('simaguang')">
                <div class="sage-avatar">ğŸ“</div>
                <div class="sage-name">å¸é©¬å…‰</div>
            </div>
            
            <div class="sage-figure sage-wangchuanshan" data-sage="wangchuanshan" onclick="exploreSage('wangchuanshan')">
                <div class="sage-avatar">â›°ï¸</div>
                <div class="sage-name">ç‹èˆ¹å±±</div>
            </div>
            
            <div class="sage-figure sage-liangqichao" data-sage="liangqichao" onclick="exploreSage('liangqichao')">
                <div class="sage-avatar">ğŸ’¡</div>
                <div class="sage-name">æ¢å¯è¶…</div>
            </div>
            
            <div class="sage-figure sage-yangengwang" data-sage="yangengwang" onclick="exploreSage('yangengwang')">
                <div class="sage-avatar">ğŸ§</div>
                <div class="sage-name">ä¸¥è€•æœ›</div>
            </div>
            
            <div class="sage-figure sage-braudel" data-sage="braudel" onclick="exploreSage('braudel')">
                <div class="sage-avatar">ğŸŒ</div>
                <div class="sage-name">å¸ƒç½—ä»£å°”</div>
            </div>
        </div>

        <!-- æ¢ç´¢æç¤º -->
        <div class="exploration-hint">
            ğŸ’§ ç‚¹å‡»æ²³æµæ¢ç´¢å†å²è„‰ç»œ | ğŸ§ ç‚¹å‡»æ™ºè€…æ·±å…¥å¯¹è¯
        </div>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgMusic" loop>
        <source src="music/sun-mountain-bg.MP3" type="audio/mpeg">
    </audio>

    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button class="music-toggle" id="musicBtn" onclick="toggleBgMusic()">ğŸµ</button>

    <script>
        // è¿”å›å…¨æ™¯å›¾
        function goBack() {
            window.location.href = 'index.html';
        }

        // æ¢ç´¢å±±è„‰ (å†å²æ²³æµ)
        function exploreRange(rangeId) {
            window.location.href = `ranges/history/${rangeId}-range.html`;
        }

        // æ¢ç´¢æ™ºè€…
        function exploreSage(sageId) {
            window.location.href = `sages/history/${sageId}.html`;
        }

        // å®‰å…¨çš„å­˜å‚¨è®¿é—®å‡½æ•°
        function getVisitedSages() {
            try {
                return JSON.parse(localStorage.getItem('visitedSages') || '[]');
            } catch (error) {
                console.log('ä½¿ç”¨å†…å­˜å­˜å‚¨æ¨¡å¼');
                return [];
            }
        }

        function setVisitedSages(sages) {
            try {
                localStorage.setItem('visitedSages', JSON.stringify(sages));
            } catch (error) {
                console.log('å­˜å‚¨å¤±è´¥');
            }
        }

        // æ£€æŸ¥å±±å³°å®ŒæˆçŠ¶æ€
        function checkMountainComplete() {
            const visitedSagesList = getVisitedSages();
            const mainHistorySages = ['simaqian', 'thucydides', 'simaguang', 'wangchuanshan', 'liangqichao', 'yangengwang', 'braudel'];

            let completedMainSages = 0;
            mainHistorySages.forEach(sage => {
                if (visitedSagesList.includes(`history-${sage}`)) { 
                    completedMainSages++;
                }
            });

            document.getElementById('mountain-progress').textContent = `${completedMainSages}/${mainHistorySages.length}`;
            document.getElementById('total-progress').textContent = `${visitedSagesList.length}/420`;
            
            // æ›´æ–°æ™ºè€…çŠ¶æ€æ˜¾ç¤º
            mainHistorySages.forEach(sage => {
                const sageElement = document.querySelector(`[data-sage="${sage}"]`);
                if (sageElement && visitedSagesList.includes(`history-${sage}`)) { 
                    sageElement.classList.add('visited');
                }
            });
            
            // å¦‚æœå®Œæˆäº†å†å²å±±çš„æ ¸å¿ƒæ™ºè€…ï¼Œæ˜¾ç¤ºæç¤º
            if (completedMainSages === mainHistorySages.length) {
                if (!localStorage.getItem('historyMountainCompleted')) {
                    localStorage.setItem('historyMountainCompleted', 'true');
                    showCompletionModal();
                }
            }
        }

        // æ˜¾ç¤ºå®Œæˆæç¤º
        function showCompletionModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: #F5DEB3; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; position: relative; border: 2px solid #8B6914;">
                    <span onclick="this.parentElement.parentElement.remove()" 
                    style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #654321; font-weight: bold;">&times;</span>
                    
                    <h3 style="color: #654321; margin-bottom: 20px;">ğŸ‰ æ­å–œå®Œæˆå†å²å±±æ¢ç´¢ï¼</h3>
                    <p style="margin-bottom: 20px; color: #5D4E37;">ä½ å·²æ‹œè®¿äº†å†å²å±±çš„æ‰€æœ‰æ™ºè€…ï¼Œè·å¾—äº†å†å²çš„æ™ºæ…§ã€‚</p>
                    
                    <button onclick="goBack()" style="background: #8B6914; color: #F5DEB3; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer;">è¿”å›å…¨æ™¯</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicBtn');

        if (bgMusic) {
            bgMusic.volume = 0.3;
        }

        function toggleBgMusic() {
            if (!bgMusic) return;
            
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    musicBtn.textContent = 'ğŸ”Š';
                }).catch(error => {
                    console.error('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶', error); // ä½¿ç”¨ console.error æ‰“å°é”™è¯¯å¯¹è±¡
                });
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'ğŸ”‡';
            }
        }

        // ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶å°è¯•æ’­æ”¾
        let hasInteracted = false;
        document.addEventListener('click', function() {
            if (!hasInteracted && bgMusic) {
                hasInteracted = true;
                bgMusic.play().then(() => {
                    musicBtn.textContent = 'ğŸ”Š';
                }).catch(error => {
                    console.error('ç”¨æˆ·äº¤äº’æ’­æ”¾å¤±è´¥', error); // ä½¿ç”¨ console.error æ‰“å°é”™è¯¯å¯¹è±¡
                });
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', checkMountainComplete);

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ²³æµæ˜¯å¦æ­£ç¡®æ˜¾ç¤º
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å†å²æ²³æµ...');
            
            const rivers = document.querySelectorAll('.history-river');
            console.log('æ‰¾åˆ°æ²³æµæ•°é‡:', rivers.length);
            
            rivers.forEach((river, index) => {
                console.log(`æ²³æµ ${index + 1}:`, {
                    element: river,
                    className: river.className,
                    innerHTML: river.innerHTML,
                    position: window.getComputedStyle(river).position,
                    bottom: window.getComputedStyle(river).bottom,
                    left: window.getComputedStyle(river).left,
                    right: window.getComputedStyle(river).right,
                    zIndex: window.getComputedStyle(river).zIndex,
                    display: window.getComputedStyle(river).display,
                    visibility: window.getComputedStyle(river).visibility
                });
            });
        });
    </script>
</body>
</html>